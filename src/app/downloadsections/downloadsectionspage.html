<ion-header>
  <ion-toolbar>
    <ion-title>Download Sections</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div *ngIf="jsonData.length > 0">
    <!-- Row 1: Subjects -->
    <ion-grid>
      <ion-row>
        <ion-col size="auto" *ngFor="let subject of jsonData; let subjectIndex = index">
          <ion-button 
            [color]="selectedSubjectIndex === subjectIndex ? 'primary' : 'medium'"
            (click)="selectSubject(subjectIndex)">
            {{ subject.SubjectName }}
          </ion-button>
        </ion-col>
      </ion-row>

      <!-- Row 2: Sections -->
      <ion-row *ngIf="selectedSubjectIndex !== null">
        <ion-col size="auto" *ngFor="let section of jsonData[selectedSubjectIndex].sections; let sectionIndex = index">
          <ion-button 
            [color]="selectedSectionIndex === sectionIndex ? 'secondary' : 'medium'"
            (click)="selectSection(sectionIndex)">
            {{ section.SectionName }}
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Section Questions -->
    <div *ngIf="selectedSectionIndex !== null">
      <div *ngFor="let question of selectedSection?.questions">
        <!-- Question Card -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              Q{{ question.question_id }} - {{ question.qtype }}
            </ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <img *ngIf="question.questionImgName" [src]="question.questionImgName" alt="Question Image" style="max-width: 100%; margin-bottom: 10px;">
            <p>{{ question.document_name }}</p>

            <div *ngIf="question.options?.length > 0">
              <!-- MCQ -->
              <div *ngIf="question.qtype === 'MCQ'">
                <ion-item *ngFor="let option of question.options">
                  <div class="custom-radio">
                    <div
                      class="circle"
                      [ngClass]="{
                        'selected': question.userAnswer?.includes(option.option_index),
                        'correct': question.showResult && question.answer.includes(option.option_index),
                        'wrong': question.showResult && !question.answer.includes(option.option_index) && question.userAnswer?.includes(option.option_index),
                        'disabled': canShowSolution(question) || isOptionDisabled(question, option) }">
                      <!-- Conditional Icon -->
                      <ng-container *ngIf="question.showResult">
                        <!-- Show ❌ for incorrect answer -->
                        <ng-container *ngIf="option.option_index === question.userAnswer && !question.isCorrect">
                          ❌
                        </ng-container>
                        <!-- Show ✅ for correct answer -->
                        <ng-container *ngIf="option.option_index === question.answer">
                          ✔️
                        </ng-container>
                      </ng-container>
                      <!-- Display option index when the result is not shown -->
                      <ng-container *ngIf="!question.showResult">{{ option.option_index }}</ng-container>
                    </div>
                  </div>
                  <ion-label (click)="!canShowSolution(question) && handleAnswer(question.question_id, option.option_index)">
                    <img [src]="option.optionImgName" alt="Option Image" class="option-image">
                  </ion-label>
                </ion-item>
              </div>
              
              <div *ngIf="question.qtype === 'MSQ'">
                <ion-item *ngFor="let option of question.options">
                  <div class="option-container"   (click)="handleMSQAnswer(question.question_id, option.option_index, $event)">
                    <div
                      class="square"
                      [ngClass]="{
                        'selected': question.userAnswer?.includes(option.option_index),
                        'correct': question.showResult && question.answer.includes(option.option_index),
                        'wrong': question.showResult && !question.answer.includes(option.option_index) && question.userAnswer?.includes(option.option_index),
                        'disabled': canShowSolution(question)
                      }"
                  >
                  <ng-container *ngIf="question.showResult">
                    <!-- Show ❌ for incorrect answer -->
                    <ng-container *ngIf="!question.answer.includes(option.option_index) && question.selectedOptions?.includes(option.option_index)">
                      ❌
                    </ng-container>
                    
                    <!-- Show ✅ for correct answer -->
                    <ng-container *ngIf="question.answer.includes(option.option_index) && question.selectedOptions?.includes(option.option_index)">
                      ✔️
                    </ng-container>
                  </ng-container>
                  <ng-container *ngIf="!question.showResult">{{ option.option_index }}</ng-container>
                    </div>
                    <ion-label>
                      <img *ngIf="option.optionImgName" [src]="option.optionImgName" alt="Option Image" class="option-image">
                    </ion-label>
                  </div>
                </ion-item>
              </div>
            </div>  

              
              
          

            <!-- Show Solution Button -->
           <ion-button 
  expand="block" 
  color="tertiary" 
  (click)="toggleSolution(question)" 
  [disabled]="!canShowSolution(question)">
  {{ question.showSolution ? 'Hide Solution' : 'Show Solution' }}
</ion-button>
          </ion-card-content>
        </ion-card>

        <!-- Solution Display -->
        <ion-card *ngIf="question.showSolution" color="light">
          <ion-card-header>
            <ion-card-subtitle>Result</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <p [style.color]="question.isCorrect ? 'green' : 'red'">
              {{ question.isCorrect ? '✅ Correct!' : '❌ Incorrect!' }}
            </p>
            <img *ngIf="question.solution" [src]="question.solution" alt="Solution Image" style="max-width: 100%;">
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </div>
</ion-content>
